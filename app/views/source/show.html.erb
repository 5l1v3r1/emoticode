<section id="source">
  <div class="small-column">
    <div id="publisher">
      <span class="author">
        <a href="<%= user_profile_path(username:@source.user.username) %>" title="<%= @source.user.username %> profile">
          <%= avatar_tag @source.user %>
          <%= truncate @source.user.username, :length => 15 %>
        </a>
      </span>

      <span class="info">
        Posted into <%= link_to @source.language.title, language_archive_path(@source.language.name), { :class => 'language' } %> 
        <br/>
        <%= time_ago_in_words( Time.at(@source.created_at) ) %> ago
        <br/> 
        <%= @source.views %> views 
      </span>
      
      <ul class="buttons">
        <% if signed_in? %>
          <% if @current_user == @source.user or @current_user.is_admin? %>
            <li>
              <%= link_icon_to 'Edit', 'edit', source_edit_path(@source) %>
            </li>
            <li>
              <%= link_icon_to 'Delete', 'trash', source_delete_path(@source), :data => { :confirm => 'Are you sure?' } %>
            </li>
          <% end %>

          <li>
          <% if @current_user.favorite? @source %>
            <%= link_icon_to 'Unfav', 'thumbs-down', unfavorite_path( id:@source.id, format: :js ), id: "fav-#{@source.id}", method: :post, remote: true  %>
          <% else %>
            <%= link_icon_to 'Fav It!', 'thumbs-up', favorite_path( id:@source.id, format: :js ), id: "fav-#{@source.id}", method: :post, remote: true  %>
          <% end %>
          </li>
        <% else %>
          <li>
            <%= link_icon_to_function "Fav It!", 'thumbs-up', 'showLoginModal()' %>
          </li>
        <% end %>
        </li>
        <li>
          <%= link_icon_to 'Raw', 'file-text', raw_with_language_path( :language_name => @source.language.name, :source_name => @source.name ) %> 
        </li>

        <li>
          <%= link_icon_to_function "Embed", "expand", "$('#embed').modal();" %>
        </li>
      </ul>

      <div id="share">
        <a class="socialite twitter-share" href="http://twitter.com/share" data-url="<%= @source.url %>" data-count="vertical" data-width="60" rel="nofollow" target="_blank">
          Share on Twitter
        </a> 
        <a href="https://plusone.google.com/_/+1/confirm?hl=en&amp;url=<%= @source.url %>" class="socialite googleplus-one" data-size="tall" data-href="<%= @source.url %>" rel="nofollow" target="_blank">
          Share on Google+
        </a>
        <a href="http://www.facebook.com/sharer.php?u=<%= @source.url %>&amp;t=<%= @source.title %>" class="socialite facebook-like" data-href="<%= @source.url %>" data-send="false" data-layout="box_count" data-width="60" data-show-faces="false" rel="nofollow" target="_blank">
        Share on Facebook
        </a>
      </div>

      <script>
        // load socialize ASAP
        Socialite.load();

        // handle scrolling for share bar
        $(function () {

          var msie6 = $.browser == 'msie' && $.browser.version < 7;
          
          if (!msie6) {
            var top = $('#share').offset().top;
            $(window).scroll(function (event) {
              // what the y position of the scroll is
              var y = $(this).scrollTop();
              
              // whether that's below the starting position
              if (y >= top) {
                // if so, ad the fixed class
                $('#share').addClass('fixed');
              } else {
                // otherwise remove it
                $('#share').removeClass('fixed');
              }
            });
          }  
        });
    </script>
    </div>
  </div>  

  <div class="medium-column">
    <h1><%= @source.title %></h1>
    <p class="description"><%=raw description(@source) %></p>
    <%=raw highlight(@source) %>
    
    <%= render :partial => 'comments/box', :locals => { object: @source } %>
  </div>

  <%= render :partial => 'layouts/sidebar', :locals => { with_heading: true, source: @source } %>
</section>

<%= modal_dialog 'embed', 'Embed Me!' do %>
  <textarea><script type="text/javascript" src="<%= @source.url.gsub /\.html$/, '.js' %>"></script></textarea>
<% end %>
